<!-- Global meta tags added for PWA compatibility -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#4CAF50">
<link rel="manifest" href="/manifest.json">
<!-- iOS PWA meta tags -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="PlantPal">
<!-- iOS icon links -->
<link rel="apple-touch-icon" href="/images/icon-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="/images/icon-512.png">
<link rel="apple-touch-icon" sizes="384x384" href="/images/icon-384.png">
<link rel="apple-touch-icon" sizes="192x192" href="/images/icon-192.png">
<link rel="apple-touch-icon" sizes="96x96" href="/images/icon-96.png">
<link rel="apple-touch-icon" sizes="72x72" href="/images/icon-72.png">
<link rel="apple-touch-icon" sizes="48x48" href="/images/icon-48.png">
<script>
    // Register service worker for all pages
    if ("serviceWorker" in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register("/serviceWorker.js", {
                scope: "/",
            }).then((registration) => {
                console.log("Service Worker registered successfully:", registration);
                
                // Check for updates
                registration.addEventListener('updatefound', () => {
                    console.log('Service Worker update found');
                    const newWorker = registration.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            console.log('New content is available; please refresh.');
                        }
                    });
                });
            }).catch((error) => {
                console.error("Service Worker registration failed:", error);
            });
        });
    }
    
    // PWA installation logic
    let deferredPrompt;
    const installButton = document.getElementById('installPWA');
    
    window.addEventListener('beforeinstallprompt', (e) => {
        // Prevent Chrome 67 and earlier from automatically showing the prompt
        e.preventDefault();
        // Stash the event so it can be triggered later
        deferredPrompt = e;
        // Update UI to notify the user they can add to home screen
        installButton.classList.remove('hidden');
        
        installButton.addEventListener('click', (e) => {
            // Show the install prompt
            deferredPrompt.prompt();
            // Wait for the user to respond to the prompt
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('User accepted the A2HS prompt');
                    // Hide the button after installation
                    installButton.classList.add('hidden');
                } else {
                    console.log('User dismissed the A2HS prompt');
                }
                deferredPrompt = null;
            });
        });
    });
    
    // Hide the install button when the PWA is already installed
    window.addEventListener('appinstalled', (evt) => {
        console.log('App was installed');
        installButton.classList.add('hidden');
    });
</script>

<header class="bg-white shadow-md px-4 sm:px-6 w-full fixed top-0 flex flex-row justify-between items-center z-50 h-20">
    <div class="flex flex-row items-center flex-shrink-0">
        <img src="/images/logo.jpg" alt="Logo" class="h-12 w-12 sm:h-14 sm:w-14 mr-3 rounded-xl object-cover" style="max-width: 66px; max-height: 66px;" />
        <h1 class="text-lg sm:text-2xl font-bold text-neutral">PlantPal</h1>
    </div>
    
    <!-- Install PWA Button - Hidden by default, shown when installation is possible -->
    <button id="installPWA" class="btn btn-sm btn-primary hidden mx-2">
        Install App <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="ml-2" viewBox="0 0 16 16">
            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
        </svg>
    </button>

    <div class="flex flex-row items-center text-2xl sm:text-4xl gap-2 sm:gap-3 flex-shrink-0">
        <h1 class="text-gray-950 hidden sm:inline font-bold">Welcome</h1>
        <div class="text-2xl sm:text-4xl font-bold text-neutral normal-case" id="welcomeUserText"></div>
    </div>

    <button
        class="btn btn-neutral btn-outline rounded-lg text-sm sm:text-base flex-shrink-0"
        onclick="logout()"
        id="logoutButton"
    >
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
            <path d="M15 24H1c-.6 0-1-.4-1-1V1c0-.6.4-1 1-1h14c.6 0 1 .4 1 1v7c0 .6-.4 1-1 1s-1-.4-1-1V2H2v20h12v-6c0-.6.4-1 1-1s1 .4 1 1v7c0 .6-.4 1-1 1z"/>
            <path d="M23 13H8c-.6 0-1-.4-1-1s.4-1 1-1h15c.6 0 1 .4 1 1s-.4 1-1 1z"/>
            <path d="M23 13c-.3 0-.5-.1-.7-.3l-4-4c-.4-.4-.4-1 0-1.4s1-.4 1.4 0l4 4c.4.4.4 1 0 1.4-.2.2-.4.3-.7.3z"/>
            <path d="M19 17c-.3 0-.5-.1-.7-.3-.4-.4-.4-1 0-1.4l4-4c.4-.4 1-.4 1.4 0s.4 1 0 1.4l-4 4c-.2.2-.4.3-.7.3z"/>
        </svg>
        <div class="text-sm hidden md:block">Logout</div>
    </button>

    <dialog id="loginUserModel" class="modal">
            <div class="modal-box place-content-center items-center flex flex-col w-full">
            <h3 class="font-bold text-2xl w-full text-center">
                Join the Plant Sharing Community
            </h3>
            <img src="/images/login.jpg" alt="Login" class="h-96" />
            <form onsubmit="event.preventDefault(); logInUser()" class="w-full">
                <label class="input input-bordered flex items-center gap-2 my-4 rounded-lg">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 24 24"
                        fill="currentColor"
                        class="w-4 h-4 opacity-70"
                    >
                        <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6ZM12.735 14c.618 0 1.093-.561.872-1.139a6.002 6.002 0 0 0-11.215 0c-.22.578.254 1.139.872 1.139h9.47Z"/>
                    </svg>
                    <input
                        id="userName"
                        type="text"
                        placeholder="Username"
                        class="grow rounded-sm"
                        required
                        minlength="2"
                        maxlength="20"
                    />
                </label>

                <button class="btn btn-neutrl w-full rounded-lg" type="submit">
                    Join Now
                </button>
            </form>
        </div>
    </dialog>
</header>
                    
