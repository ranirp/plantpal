<%#
/**
 * @template PlantDetails
 * @description Combined plant details and chat interface
 * 
 * Features:
 * - Split-screen layout (details + chat)
 * - Offline plant data support
 * - Real-time chat integration
 * - Responsive design
 * - Online/offline mode indicator
 * 
 * Required Data:
 * @param {Object} data - Plant details
 * @param {string} data._id - Plant ID
 * @param {string} data.nickname - Plant owner's nickname
 * @param {boolean} isOfflineMode - Whether app is in offline mode
 * @param {boolean} data.isOfflinePlant - Whether plant was created offline
 * @param {string} username - Current user's username
 * 
 * Components:
 * - plantDetailsComponent.ejs - Plant information display
 * - chat.ejs - Chat interface
 * - onlineOfflineMode.ejs - Connection status indicator
 */
%>

<!DOCTYPE html>
<html data-theme="cupcake">
    <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="PlantPal">
    <title>PlantPal</title>
        <link rel="stylesheet" href="/css/outputStyles.css" />
        <link rel="manifest" href="/manifest.json"/>
        <script defer>
            var loggedInUser = "<%= username %>";
            var plantId = "<%= Buffer.from(data._id.toString()).toString('base64') %>"; // Base64 encoded plant ID
            var plantOwner = "<%= data.nickname %>";
            var isOfflineMode = "<%= (typeof isOfflineMode !== 'undefined' && isOfflineMode) ? 'true' : 'false' %>";
            var isOfflinePlant = "<%= data.isOfflinePlant ? 'true' : 'false' %>";
        </script>
        <% if (typeof isOfflineMode !== 'undefined' && isOfflineMode) { %>
        <!-- Load plant data from IndexedDB for offline plants -->
        <script src="/javascripts/addPlant/addPlantUtility.js"></script>
        <script>
            // Load offline plant data when page loads
            document.addEventListener('DOMContentLoaded', async function() {
                if (isOfflinePlant) {
                    console.log('üîÑ Loading offline plant data from IndexedDB...');
                    try {
                        const db = await openSyncPlantIDB();
                        const allPlants = await getAllPlantsFromIDB();
                        const decodedPlantId = atob(plantId); // Decode base64
                        
                        // Find the plant by ID
                        const plant = allPlants.find(p => p._id === decodedPlantId);
                        
                        if (plant) {
                            console.log('‚úÖ Found offline plant:', plant);
                            // Update the page with actual plant data
                            document.title = plant.plantName + ' - Plant Details (Offline)';
                            window.offlinePlantData = plant;
                        } else {
                            console.error('‚ùå Offline plant not found in IndexedDB');
                        }
                    } catch (error) {
                        console.error('‚ùå Error loading offline plant:', error);
                    }
                }
            });
        </script>
        <% } %>
    </head>
    <body>
        <div class="flex flex-col h-screen w-full lg:flex-row gap-4 p-4">
            <!-- Plant Details Section -->
            <div class="lg:w-1/2 h-full bg-white rounded-lg shadow-lg border border-gray-200">
                <div class="h-full overflow-y-auto">
                    <%- include('./plantDetailsComponent.ejs', { data: data}) %>
                </div>
            </div>

            <!-- Chat Section -->
            <div class="lg:w-1/2 h-full bg-white rounded-lg shadow-lg border border-gray-200">
                <div class="flex flex-col h-full">
                    <%- include('../chat/chat.ejs', { data: data, userName: username }) %>
                </div>
            </div>
        </div>
        
        <%- include('../components/onlineOfflineMode.ejs') %>
    </body>
</html>